---
title: "Analysis 'Projektarbeit 2017'"
---

## Clearing work enviroment, setting libraries and constants
```{r}
rm(list=ls())

library(tidyverse)
library(papaja)
library(car)
library(afex)

pathMEM <- "data/Memory/"
pathET <- "data/prot/"
pathFB <- "data/FB/"

```



## Reading eye tracking data in
```{r}
options(warn=0)  # 2=Turn warnings into errors / 0=default

# ALL DATA
vpn <- paste("vpja",ifelse(c(1:78,81:96)<10,"0",""),c(1:78,81:96),sep="")
bed <- rep(c("free","mem"),47)

# ORIGINALLY ACQUIRED DATA
#vpn <- paste("vpja",ifelse(c(1:78)<10,"0",""),c(1:78),sep="")
#bed <- rep(c("free","mem"),39)

bed <- bed[!(vpn %in% "vpja23")]  # Daten fehlen
vpn <- vpn[!(vpn %in% "vpja23")]  

# Loop over subjects
erg <- numeric(); nvalid <- numeric(); cleantime <- numeric()
for (vp in vpn) {
  #  print(vp)

  prot <- read.csv2(paste(pathET,vp,"_Fixations.csv",sep=""))

  # Restrict to trials with valid baseline?
  nvalid <- c(nvalid,sum(prot$blok==1))
  prot <- prot[prot$blok==1,]

  cleantime <- c(cleantime,mean(prot$cleantime))

  erg <- rbind(erg,apply(prot[,8:ncol(prot)],2,mean,na.rm=TRUE))
}

df.w.et <- data.frame(code=vpn,group=bed,nvalid,cleantime,erg)


df.l.et <- gather(df.w.et, key, value, fix.face:sac.bnongaze, factor_key=TRUE) %>%
  mutate(
    key = as.character(key),
    fixations =
      as.factor(
        ifelse(startsWith(key, "fix."), "fix",
             ifelse(startsWith(key, "fixn."), "fixn",
                    ifelse(startsWith(key, "fixlat."), "fixlat",NA)))),
    region =
      as.factor(
        ifelse(endsWith(key, ".face"), "face",
               ifelse(endsWith(key, ".body"), "body",
                      ifelse(endsWith(key, ".gaze"), "gaze",
                             ifelse(endsWith(key, ".nongaze"), "nongaze", NA))))),
    saccades = as.factor(
      ifelse(endsWith(key, ".pgaze"), "pgaze",
             ifelse(endsWith(key, ".fgaze"), "fgaze",
                    ifelse(endsWith(key, ".bgaze"), "bgaze",
                           ifelse(endsWith(key, ".pnongaze"), "pnongaze",
                                  ifelse(endsWith(key, ".fnongaze"), "fnongaze",
                                         ifelse(endsWith(key, ".bnongaze"), "bnongaze", NA)))))))) %>%
  arrange(code)

rm(prot, bed, cleantime, nvalid, vp, vpn, erg)
```



## Reading memory data in
```{r}

# ALL DATA
vpn <- paste("vpja",ifelse(c(1:78,81:96)<10,"0",""),c(1:78,81:96),sep="")
bed <- rep(c("free","mem"),47)

# ORIGINALLY ACQUIRED DATA
#vpn <- paste("vpja",ifelse(c(1:78)<10,"0",""),c(1:78),sep="")
#bed <- rep(c("free","mem"),39)

# Loop over subjects
erg <- numeric()
for (vp in vpn) {
  # print(vp)

  prot <- read.csv2(paste(pathMEM,vp,".csv",sep=""))

  # Item recalled
  gaze <- sum(prot$memgazedat)
  nogaze <- sum(prot$memnongazedat)

  erg <- rbind(erg,c(gaze,nogaze))
}

df.w.mem <- data.frame(code=vpn,bed,erg)               
names(df.w.mem) <- c("code","bed","memgaze","memnogaze")

rm(gaze, nogaze, erg, prot, bed, vp, vpn)
```



## Reading questionnaire data in
```{r}

df.w.demo <- read_csv2(paste(pathFB,"Projektarbeit_Dateneingabemaske.csv", sep="")) %>%
  transmute(
    vp = as.factor(VP_Nr),
    sex = as.factor(Demo_Sex),
    age = Demo_Alter,
    aq_social = ifelse((5-AQK_1) < 3, 1, 0) + ifelse((5-AQK_7) < 3, 1, 0) + ifelse(AQK_8 < 3, 1, 0) + ifelse((5-AQK_10) < 3, 1, 0) + ifelse((5-AQK_11) < 3, 1, 0) + ifelse(AQK_13 < 3, 1, 0) + ifelse((5-AQK_14) < 3, 1, 0) + ifelse((5-AQK_20) < 3, 1, 0) + ifelse((5-AQK_24) < 3, 1, 0) + ifelse((5-AQK_28) < 3, 1, 0) + ifelse((5-AQK_31) < 3, 1, 0), # 5- 'item' for reversed items, then if 1/2 -> 1, 3/4 -> 0  
    aq_imagination = ifelse((5-AQK_3) < 3, 1, 0) + ifelse((5-AQK_5) < 3, 1, 0) + ifelse((5-AQK_6) < 3, 1, 0) + ifelse((5-AQK_9) < 3, 1, 0) + ifelse((5-AQK_16) < 3, 1, 0) + ifelse((5-AQK_17) < 3, 1, 0) + ifelse((5-AQK_18) < 3, 1, 0) + ifelse((5-AQK_22) < 3, 1, 0) + ifelse((5-AQK_23) < 3, 1, 0) + ifelse((5-AQK_26) < 3, 1, 0) + ifelse((5-AQK_32) < 3, 1, 0) + ifelse((5-AQK_33) < 3, 1, 0),
    aq_communication = ifelse(AQK_2 < 3, 1, 0) + ifelse(AQK_4 < 3, 1, 0) + ifelse(AQK_12 < 3, 1, 0) + ifelse(AQK_15 < 3, 1, 0) + ifelse(AQK_19 < 3, 1, 0) + ifelse(AQK_21 < 3, 1, 0) + ifelse(AQK_25 < 3, 1, 0) + ifelse(AQK_27 < 3, 1, 0) + ifelse(AQK_29 < 3, 1, 0) + ifelse(AQK_30 < 3, 1, 0),
    aq_sumscore = ifelse((5-AQK_1) < 3, 1, 0) + ifelse(AQK_2 < 3, 1, 0) + ifelse((5-AQK_3) < 3, 1, 0) + ifelse(AQK_4 < 3, 1, 0) + ifelse((5-AQK_5) < 3, 1, 0) + ifelse((5-AQK_6) < 3, 1, 0) + ifelse((5-AQK_7) < 3, 1, 0) + ifelse(AQK_8 < 3, 1, 0) + ifelse((5-AQK_9) < 3, 1, 0) + ifelse((5-AQK_10) < 3, 1, 0) + ifelse((5-AQK_11) < 3, 1, 0) + ifelse(AQK_12 < 3, 1, 0) + ifelse(AQK_13 < 3, 1, 0) + ifelse((5-AQK_14) < 3, 1, 0) + ifelse(AQK_15 < 3, 1, 0) + ifelse((5-AQK_16) < 3, 1, 0) + ifelse((5-AQK_17) < 3, 1, 0) + ifelse((5-AQK_18) < 3, 1, 0) + ifelse(AQK_19 < 3, 1, 0) + ifelse((5-AQK_20) < 3, 1, 0) + ifelse(AQK_21 < 3, 1, 0) + ifelse((5-AQK_22) < 3, 1, 0) + ifelse((5-AQK_23) < 3, 1, 0) + ifelse((5-AQK_24) < 3, 1, 0) + ifelse(AQK_25 < 3, 1, 0) + ifelse((5-AQK_26) < 3, 1, 0) + ifelse(AQK_27 < 3, 1, 0) + ifelse((5-AQK_28) < 3, 1, 0) + ifelse(AQK_29 < 3, 1, 0) + ifelse(AQK_30 < 3, 1, 0) + ifelse((5-AQK_31) < 3, 1, 0) + ifelse((5-AQK_32) < 3, 1, 0) + ifelse((5-AQK_33) < 3, 1, 0))

```



## Plots fixation and saccades by Matthias
```{r}
####################################################
# Plots: Fixation data
x11()
par(mfrow=c(2,3))

farben <- c("green","red","blue","yellow")

for (st in seq(5,16,4)) {
  # Fixation density
  m  <- cbind(apply(df.w.et[df.w.et$group=="free",st:(st+3)],2,mean),
              apply(df.w.et[df.w.et$group=="mem",st:(st+3)],2,mean))
  se <- cbind(apply(df.w.et[df.w.et$group=="free",st:(st+3)],2,sd)/sqrt(sum(df.w.et$group=="free")),
              apply(df.w.et[df.w.et$group=="mem",st:(st+3)],2,sd)/sqrt(sum(df.w.et$group=="mem")))

  yrng <- c(0,max(m+se))

  x <- barplot(m,beside=TRUE,col=farben,ylim=yrng,xlab="",ylab="% of total fixation time")
  arrows(x,m-se,x,m+se,length=0.03,angle=90,code=3,col="black")
  axis(1,apply(x,2,mean),c("Free viewing","Explicit encoding"),tick=FALSE)
}

legend(max(x),max(yrng),c("Face","Body","Cued","Uncued"),fill=farben,xjust=1,yjust=1)

# Plots: Saccade data
farben <- c("blue","yellow")
ttxt <- c("Person","Face","Body")

for (i in 1:3) {
  st <- (17:19)[i]

  # Fixation density
  m  <- cbind(apply(df.w.et[df.w.et$group=="free",c(st,st+3)],2,mean),
              apply(df.w.et[df.w.et$group=="mem",c(st,st+3)],2,mean))
  se <- cbind(apply(df.w.et[df.w.et$group=="free",c(st,st+3)],2,sd)/sqrt(sum(df.w.et$group=="free")),
              apply(df.w.et[df.w.et$group=="mem",c(st,st+3)],2,sd)/sqrt(sum(df.w.et$group=="mem")))

  yrng <- c(0,max(m+se))

  x <- barplot(m,beside=TRUE,col=farben,ylim=yrng,xlab="",ylab="% of total fixation time")
  arrows(x,m-se,x,m+se,length=0.03,angle=90,code=3,col="black")
  axis(1,apply(x,2,mean),c("Free viewing","Explicit encoding"),tick=FALSE)

  title(ttxt[i])
}

legend(max(x),max(yrng),c("Cued","Uncued"),fill=farben,xjust=1,yjust=1)

rm(m, se, x, farben, i, st, ttxt, yrng)
```



## t-tests by Matthias, apdaptet
```{r}
# Fixations Face in Free Viewing vs. Explicit Encoding
ergtabface <- numeric()
for (st in seq(5,16,4)) { # Variables 5:16, every 4th; free: fix.face and fixn.face; fixlat.face; and mem: ...
  msd <- c(mean(df.w.et[df.w.et$group=="free",st]),sd(df.w.et[df.w.et$group=="free",st]),
           mean(df.w.et[df.w.et$group=="mem",st]),sd(df.w.et[df.w.et$group=="mem",st]))
  teststat <- t.test(df.w.et[,st] ~ df.w.et$group)

  ergtabface <- rbind(ergtabface,c(msd,teststat$parameter,teststat$statistic,teststat$p.value))
}

colnames(ergtabface) <- c("M(free)","SD(free)","M(mem)","SD(mem)","df","t","p")
rownames(ergtabface) <- c("fix.face","fixn.face","fixlat.face")
print(ergtabface)


# Fixations Body in Free Viewing vs. Explicit Encoding
ergtabbody <- numeric()
for (st in seq(6,16,4)) { # Variables 5:16, every 4th; free: fix.face and fixn.face; fixlat.face; and mem: ...
  msd <- c(mean(df.w.et[df.w.et$group=="free",st]),sd(df.w.et[df.w.et$group=="free",st]),
           mean(df.w.et[df.w.et$group=="mem",st]),sd(df.w.et[df.w.et$group=="mem",st]))
  teststat <- t.test(df.w.et[,st] ~ df.w.et$group)

  ergtabbody <- rbind(ergtabbody,c(msd,teststat$parameter,teststat$statistic,teststat$p.value))
}

colnames(ergtabbody) <- c("M(free)","SD(free)","M(mem)","SD(mem)","df","t","p")
rownames(ergtabbody) <- c("fix.body","fixn.body","fixlat.body")
print(ergtabbody)

#rm(msd, teststat, st)

```


## Anova fixations by Matthias, apdaptet
```{r}
# ANOVA Fixations characteristics
## 2 (Group) x 2 (Gaze) ANOVA

icond <- gl(2,1,labels=c("cued","uncued")) # within-factor
idata <- data.frame(icond)

anova.fixgaze <-  list()

for (st in seq(7,16,4)) { # Variables 5:16, every 4th: fix.gaze and fix.nogaze; fixn.gaze and ...
  carmod <- lm(as.matrix(df.w.et[,st:(st+1)]) ~ df.w.et$group)
  #print(Anova(carmod, idata=idata, idesign=~icond, type="III"))
  anova.fixgaze <- append(anova.fixgaze, list(carmod))
  }

print("fix.gaze")
print(Anova(anova.fixgaze[[1]], idata=idata, idesign=~icond, type="III"))
apa.fix.gaze <- apa_print(Anova(anova.fixgaze[[1]], idata=idata, idesign=~icond, type="III"))

print("fixn.gaze")
print(Anova(anova.fixgaze[[2]], idata=idata, idesign=~icond, type="III"))
apa.fixn.gaze <- apa_print(Anova(anova.fixgaze[[2]], idata=idata, idesign=~icond, type="III"))


print("fixlat.gaze")
print(Anova(anova.fixgaze[[3]], idata=idata, idesign=~icond, type="III"))
apa.fixlat.gaze <- apa_print(Anova(anova.fixgaze[[2]], idata=idata, idesign=~icond, type="III"))

df.w.et %>% summarise(mean(fix.gaze), mean(fix.nongaze), mean(fixn.gaze), mean(fixn.nongaze), mean(fixlat.gaze), mean(fixlat.nongaze))
df.w.et %>% group_by(group) %>% summarise(mean(fix.gaze), mean(fix.nongaze), mean(fixn.gaze), mean(fixn.nongaze), mean(fixlat.gaze), mean(fixlat.nongaze))

rm(carmod, idata, icond, st)

```


## Anova saccades by Matthias, apdaptet
```{r}
# ANOVA Saccades
## 2 (Group) x 2 (Gaze) ANOVA
icond <- gl(2,1,labels=c("cued","uncued")) # within-factor
idata <- data.frame(icond)

anova.sacgaze <-  list()

for (st in 17:19) {
  carmod <- lm(as.matrix(df.w.et[,c(st,st+3)]) ~ df.w.et$group)
  #print(Anova(carmod, idata=idata, idesign=~icond, type="III"))
  anova.sacgaze <- append(anova.sacgaze, list(carmod))
  }

print("pgaze")
print(Anova(anova.sacgaze[[1]], idata=idata, idesign=~icond, type="III"))
apa.sac.pgaze <- apa_print(Anova(anova.sacgaze[[1]], idata=idata, idesign=~icond, type="III"))

print("fgaze")
print(Anova(anova.sacgaze[[2]], idata=idata, idesign=~icond, type="III"))
apa.sac.fgaze <- apa_print(Anova(anova.sacgaze[[2]], idata=idata, idesign=~icond, type="III"))

print("bgaze")
print(Anova(anova.sacgaze[[3]], idata=idata, idesign=~icond, type="III"))
apa.sac.bgaze <- apa_print(Anova(anova.sacgaze[[3]], idata=idata, idesign=~icond, type="III"))

df.w.et %>% summarise(mean(sac.pgaze), mean(sac.pnongaze), mean(sac.fgaze), mean(sac.fnongaze), mean(sac.bgaze), mean(sac.bnongaze))
df.w.et %>% group_by(group) %>% summarise(mean(sac.pgaze), mean(sac.pnongaze), mean(sac.fgaze), mean(sac.fnongaze), mean(sac.bgaze), mean(sac.bnongaze))

rm(carmod, idata, icond, st)
```

## Plots memory by Matthias
```{r}
# Plots
x11()

farben <- c("red","blue")

# Fixation density
m  <- cbind(apply(df.w.mem[df.w.mem$bed=="free",3:4],2,mean),
            apply(df.w.mem[df.w.mem$bed=="mem",3:4],2,mean))
se <- cbind(apply(df.w.mem[df.w.mem$bed=="free",3:4],2,sd)/sqrt(sum(df.w.mem$bed=="free")),
            apply(df.w.mem[df.w.mem$bed=="mem",3:4],2,sd)/sqrt(sum(df.w.mem$bed=="mem")))


x <- barplot(m,beside=TRUE,col=farben,ylim=c(0,10),xlab="",ylab="% of total fixation time")
arrows(x,m-se,x,m+se,length=0.03,angle=90,code=3,col="black")
axis(1,apply(x,2,mean),c("Free viewing","Explicit encoding"),tick=FALSE)

legend(min(x),10,c("Gazed at object","Non-gazed at object"),fill=farben,xjust=0,yjust=1)

rm(m, se, x, farben)
```


## Anova memory by Matthias, adapted
```{r}
# ANOVAs

# Recalled items
# 2 (Condition) x 2 (Gaze) ANOVA (auf erinnerte Details)
imem <- gl(2,1,labels=c("cued","uncued"))
idata <- data.frame(imem)

# Car
carmod <- lm(as.matrix(df.w.mem[,3:4]) ~ df.w.mem$bed)
#print(Anova(carmod, idata=idata, idesign=~imem, type="III"))
anova.mem <- carmod

print("memory")
print(Anova(anova.mem, idata=idata, idesign=~imem, type="III"))
apa.mem <- apa_print(Anova(anova.mem, idata=idata, idesign=~imem, type="III"))

df.w.mem %>% summarise(mean(memgaze), mean(memnogaze))
df.w.mem %>% group_by(bed) %>% summarise(mean(memgaze), mean(memnogaze))

rm(imem, idata, carmod)
```




Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Ctrl+Alt+I*.

When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Ctrl+Shift+K* to preview the HTML file).
